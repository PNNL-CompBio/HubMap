---
title: "HubMap pancreata figures and analysis"
output: html_document
---

This document describes the basic analysis we need to showcase the value of the Hubmap data and proteomics analysis.

```{r loading, echo=F, warning=F, message=F}
library(dplyr)
library(purrr)
library(devtools)
#library(MSnSet.utils)
if(!require(MSnSet.utils))
  devtools::install_github('PNNL-Comp-Mass-Spec/MSnSet.utils')

library(ggplot2)
library(ggfortify)
library(cowplot)


islets <- c(0:4, 7, 10)

#files <- sprintf("%g/data/%g_global_crosstab.txt", islets, islets)

source("synapseUtil.R")
syn<-synapseLogin()
```

Note that we store all files on synapse at [http://synapse.org/hubmap](http://synapse.org/hubmap). This includes basic data files and analysis results.
```{r read in crosstabs and metadata}
crosstabs<-list(`0`='syn30389393',`10`='syn30385467',`1`='syn30385349',`2`='syn30385407',
                `3`='syn30385441',`4`='syn30385450',`7`='syn30385456')

#there are also v2 crosstabs?
v2_crosstabs<-list(`0`='syn31972408',`10`='syn31972599',`1`='syn31972430',`2`='syn31972462',
                   `3`='syn31972520',`4`='syn31972565',`7`='syn31972584')

##load in crosstabs into single file
crosstabList <- lapply(names(crosstabs), function(file_i) 
  {
    islet_i <- file_i#sub("/.*", "", file_i)
    
    crosstab_i <- read.delim(syn$get(crosstabs[[file_i]])$path, row.names = 1)
    
    colnames(crosstab_i) <- paste0(islet_i, "_", colnames(crosstab_i))
    crosstab_i <- crosstab_i %>% tibble::rownames_to_column("feature")
    return(crosstab_i)
  })



##read in metadata from synaspe
library(readxl)
isletMeta <- readxl::read_xlsx(syn$get('syn30070383')$path,sheet='Metadata table')%>%#"~/Desktop/2022/Paul/Hubmap/IsletMeta_New_correct.csv") %>% 
  mutate(X_Y = paste(`Islet Number`, "S", `X-coord`, `Y-coord`, sep = "_")) %>% 
  tibble::column_to_rownames("X_Y") %>% 
  mutate(`IsletNumber` = as.character(`Islet Number`))%>%
  dplyr::rename(IsletStatus='Islet status')%>%
  mutate(IsletOrNot=stringr::str_replace_all(IsletStatus,'Proximal|Distal','NonIslet'))
  

##create single matrix
crosstab <- crosstabList %>% purrr::reduce(full_join, by = "feature") %>% 
  tibble::column_to_rownames("feature") %>% 
  as.matrix()


isletMeta <- isletMeta[colnames(crosstab), ]

```

Now we have a few ways to normalize.

### Figure 3 PCA and GSEA enrichment of islets

```{r PCA plots}

#now we deal with the larger crosstab matrix

red.crosstab <- crosstab[rowMeans(!is.na(crosstab)) >= .5, ]
red.crosstab[which(is.na(red.crosstab),arr.ind=TRUE)]<-0.0

nz.crosstab<-crosstab
nz.crosstab[which(is.na(crosstab),arr.ind=TRUE)]<-0.0
#crosstab <- crosstab[rowMeans(!is.na(crosstab)) >= .5, ]

pc.z<-prcomp(t(nz.crosstab), center=TRUE,scale.=TRUE)
pc.red<-prcomp(t(red.crosstab), center=TRUE,scale.=TRUE)


#autoplot(pc,data=isletMeta,colour='IsletNumber')

p1<-autoplot(pc.z,data=isletMeta,colour='IsletStatus')+ggtitle('Full data')
p2<-autoplot(pc.red,data=isletMeta,colour='IsletStatus')+ggtitle("Reduced data")
cowplot::plot_grid(p1,p2)

##now plotting  with msn code
isletMeta <- isletMeta[colnames(crosstab), ]

##we keep NA values in m1 and m2
red.crosstab <- crosstab[rowMeans(!is.na(crosstab)) >= .5, ]

m1 <- MSnSet(exprs = red.crosstab, pData = isletMeta)

m2<- MSnSet(exprs = crosstab, pData = isletMeta)
##Need to find the plot_pca funciton, is it in msnbase.utils?
#plot_pca(m1, phenotype = "Islet_Number") #no batch effect
p3=plot_pca(m1, phenotype = "IsletStatus",z_score=T)+ggtitle('Reduced data') #check biplot = T?
p4=plot_pca(m2, phenotype = "IsletStatus",z_score=T)+ggtitle("Full data") #check biplot = T?

cowplot::plot_grid(p3,p4)

p5=plot_pca(m1, phenotype = "IsletNumber",z_score=T)+ggtitle('Reduced data') #check biplot = T?
p6=plot_pca(m2, phenotype = "IsletNumber",z_score=T)+ggtitle("Full data") #check biplot = T?

cowplot::plot_grid(p5,p6)
#save(m1, file = "combinedIslets_Results_New/combinedMSnSet.RData", compress = T)


```


Lastly we have the differential expression analysis

```{r diffex}
#m1 <- MSnSet(exprs = crosstab, pData = isletMeta)
#Run limma
res <- limma_contrasts(eset = m2, model.str = "~ 0 + IsletStatus", 
                       coef.str = "IsletStatus", contrasts = "IsletStatusProximal - IsletStatusDistal", trend = T, robust = T) #plot = T?

res2 <- limma_contrasts(eset = m2, model.str = "~ 0 + IsletStatus", 
                       coef.str = "IsletStatus", contrasts = "IsletStatusIslet - IsletStatusProximal", trend = T, robust = T) #plot = T?


res3 <- limma_contrasts(eset = m2, model.str = "~ 0 + IsletStatus", 
                       coef.str = "IsletStatus", contrasts = "IsletStatusIslet - IsletStatusDistal", trend = T, robust = T) #plot = T?

res4 <- limma_contrasts(eset = m2, model.str = "~ 0 + IsletOrNot", 
                       coef.str = "IsletOrNot", contrasts = "IsletOrNotIslet - IsletOrNotNonIslet", trend = T, robust = T) #plot = T?

##TODO: summary table off differential expression

```

## GSEA of Islet-enriched terms